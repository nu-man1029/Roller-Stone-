<!DOCTYPE html>
<html lang="ja">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-9KY5C7XC36"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-9KY5C7XC36');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工事請負契約書 作成システム - 高精度版</title>
    <script src="https://yubinbango.github.io/yubinbango/yubinbango.js" charset="UTF-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* --- 入力画面スタイル（変更なし） --- */
        :root { --bg-dark: #0a0a0a; --rs-gold: #c5a059; --text-white: #ffffff; --text-gray: #aaaaaa; --border-gray: #333333; }
        body { font-family: 'Helvetica Neue', Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; background-color: var(--bg-dark); color: var(--text-white); margin: 0; padding: 0; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 30px 0; border-bottom: 2px solid var(--rs-gold); margin-bottom: 20px; }
        h1 { font-size: 1.4rem; color: var(--rs-gold); margin: 0; }
        section { margin-bottom: 30px; }
        h2 { font-size: 1rem; border-left: 4px solid var(--rs-gold); padding-left: 15px; color: var(--rs-gold); margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: var(--text-gray); }
        input[type="text"], input[type="number"], input[type="date"], textarea { width: 100%; padding: 10px; box-sizing: border-box; background-color: #222; border: 1px solid var(--border-gray); border-radius: 4px; color: #fff; font-size: 16px; }
        .btn-row { display: flex; gap: 10px; margin-top: 8px; }
        button.sub-btn { background: #333; color: #fff; border: none; padding: 10px 15px; cursor: pointer; border-radius: 4px; font-size: 0.9rem; }
        .main-btn { display: block; width: 100%; padding: 18px; background: linear-gradient(135deg, #d4af37, #c5a059); color: #000; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 30px; }

        /* --- PDFプレビュー画面（超厳密設定） --- */
        #preview-screen { display: none; background-color: #555; padding: 20px 0; }
        .preview-controls { position: sticky; top: 0; background: rgba(0,0,0,0.9); padding: 15px; display: flex; justify-content: center; gap: 20px; z-index: 1000; border-bottom: 1px solid var(--rs-gold); }

        .a4-page {
            width: 210mm;
            height: 296.8mm; /* 微調整：端数による次ページはみ出し防止 */
            padding: 15mm 18mm;
            margin: 0 auto 10mm;
            background: #fff;
            color: #000;
            box-sizing: border-box;
            font-family: "MS Mincho", "Hiragino Mincho ProN", serif;
            font-size: 10pt; /* 標準サイズに戻す */
            line-height: 1.5;
            position: relative;
            page-break-after: always;
            overflow: hidden;
        }

        .stamp-box { position: absolute; top: 15mm; right: 18mm; border: 0.5pt solid #000; width: 25mm; height: 30mm; font-size: 8pt; display: flex; align-items: center; justify-content: center; text-align: center; }
        .paper-title { text-align: center; font-size: 18pt; font-weight: bold; margin: 10mm 0 8mm; text-decoration: underline; }
        .clause-title { font-weight: bold; margin-top: 8px; margin-bottom: 2px; font-size: 10.5pt; border-bottom: 0.5pt solid #000; display: block; }
        
        /* 入力箇所のアンダーライン固定 */
        .fill-in { border-bottom: 0.5pt solid #000; display: inline-block; min-width: 50px; padding: 0 5px; text-indent: 0; }
        
        .indent-1 { padding-left: 1.5em; text-indent: -1.5em; }
        .indent-2 { padding-left: 3em; text-indent: -1.5em; }

        .sign-area { margin-top: 20mm; }
        .sign-row { display: flex; border-bottom: 0.5pt solid #000; margin-bottom: 12px; }
        .sign-label { width: 90px; }
        .sign-data { flex-grow: 1; font-weight: bold; }
        .seal-mark { width: 40px; text-align: right; font-size: 12pt; }
        .page-num { position: absolute; bottom: 10mm; width: 100%; text-align: center; left: 0; font-size: 9pt; }

        @media print {
            body { background: none; }
            #preview-screen { display: block; }
            .preview-controls, #input-screen { display: none; }
            .a4-page { margin: 0; border: none; box-shadow: none; }
        }
    </style>
</head>
<body>

<div id="input-screen" class="container">
    <header><h1>工事請負契約書 作成システム</h1></header>
    <form id="contract-form">
        <section>
            <h2>第1条：当事者情報</h2>
            <div class="h-adr">
                <span class="p-country-name" style="display:none;">Japan</span>
                <div class="form-group"><label>【甲】発注者 氏名 / 会社名</label><input type="text" id="ko_name" required></div>
                <div class="form-group"><label>【甲】住所</label><input type="text" id="ko_addr" class="p-region p-locality p-street-address p-extended-address"></div>
            </div>
            <div class="h-adr">
                <div class="form-group"><label>【乙】施工者 氏名 / 会社名</label><input type="text" id="otsu_name" value="ぬーまん"></div>
                <div class="form-group"><label>【乙】住所</label><input type="text" id="otsu_addr" value="三重県松阪市下村町"></div>
            </div>
        </section>
        <section>
            <h2>第2条：工事内容</h2>
            <div class="form-group"><label>工事名</label><input type="text" id="work_name" required></div>
            <div class="form-group"><label>工事場所</label>
                <div class="btn-row">
                    <input type="text" id="work_place">
                    <button type="button" class="sub-btn" onclick="copyKoAddr()">甲の住所をコピー</button>
                </div>
            </div>
            <div class="form-group"><label>工事内容（概要）</label><textarea id="work_desc" rows="2"></textarea></div>
        </section>
        <section>
            <h2>第3条：工期</h2>
            <div class="btn-row">
                <div style="flex:1"><label>着工日</label><input type="date" id="date_start"></div>
                <div style="flex:1"><label>完成日</label><input type="date" id="date_end"></div>
                <div style="flex:1"><label>引渡日</label><input type="date" id="date_delivery"></div>
            </div>
        </section>
        <section>
            <h2>第4条：代金</h2>
            <div class="form-group"><label>請負代金（税込）</label><input type="number" id="total_price"></div>
        </section>
        <button type="button" class="main-btn" onclick="showPreview()">プレビューを表示</button>
    </form>
</div>

<div id="preview-screen">
    <div class="preview-controls">
        <button class="sub-btn" onclick="backToEdit()">編集に戻る</button>
        <button class="sub-btn" onclick="generatePDF()" style="background:var(--rs-gold); color:#000; font-weight:bold;">PDFとして保存（確定）</button>
    </div>

    <div id="content-to-export">
        <div class="a4-page">
            <div class="stamp-box">印紙</div>
            <div class="paper-title">工事請負契約書</div>
            
            <div class="clause-title">第1条（当事者）</div>
            <div>本契約の当事者は、以下の発注者及び施工者とする。</div>
            <div>発注者（以下「甲」という。）</div>
            <div class="indent-1">住　　所：<span class="fill-in" id="p_ko_addr"></span></div>
            <div class="indent-1">会社名／氏名：<span class="fill-in" id="p_ko_name"></span></div>
            <div style="margin-top:5px;">施工者（以下「乙」という。）</div>
            <div class="indent-1">住　　所：<span class="fill-in" id="p_otsu_addr"></span></div>
            <div class="indent-1">会社名／氏名：<span class="fill-in" id="p_otsu_name"></span></div>

            <div class="clause-title">第2条（契約の目的および工事内容）</div>
            <div class="indent-1">1 甲は乙に対し、下記工事（以下「本工事」という。）の施工を請け負わせ、乙はこれを完成させて甲へ引き渡す。</div>
            <div class="indent-2">(1) 工事名：<span class="fill-in" id="p_work_name"></span></div>
            <div class="indent-2">(2) 工事場所：<span class="fill-in" id="p_work_place"></span></div>
            <div class="indent-2">(3) 工事内容（概要）：<span class="fill-in" id="p_work_desc"></span></div>
            <div class="indent-1">2 本工事の具体的内容・仕様・施工範囲は設計図書等に従うものとする。</div>

            <div class="clause-title">第3条（工期）</div>
            <div class="indent-1">着工日：<span class="fill-in" id="p_date_start"></span></div>
            <div class="indent-1">完成日：<span class="fill-in" id="p_date_end"></span></div>
            <div class="indent-1">引渡日：<span class="fill-in" id="p_date_delivery"></span></div>

            <div class="clause-title">第4条（請負代金および支払方法）</div>
            <div class="indent-1">1 請負代金合計：金 <span class="fill-in" id="p_total_price"></span> 円（税込）</div>
            <div class="indent-1">2 甲が支払を遅延した場合、年14.6%の遅延損害金を支払う。</div>
            
            <div class="page-num">1 / 3</div>
        </div>

        <div class="a4-page">
            <div class="clause-title">第5条（材料の調達）</div>
            <div class="indent-1">乙は、本工事に必要な材料を自己の責任と費用負担にて調達する。</div>
            <div class="clause-title">第6条（現場管理）</div>
            <div class="indent-1">乙は、安全管理・品質管理を適切に行い、法令を遵守する。</div>
            <div class="clause-title">第7条（検査および引渡し）</div>
            <div class="indent-1">1 乙は完成後通知し、甲は1週間以内に検査を行う。合格後、乙は本工事を引渡す。</div>
            <div class="clause-title">第8条（契約不適合責任）</div>
            <div class="indent-1">不適合がある場合、引渡しから1年以内に限り補修等の責任を負う。</div>
            <div class="clause-title">第9条（追加・変更工事）</div>
            <div class="indent-1">追加工事の際は別途見積を作成し、甲の承認を得るものとする。</div>
            <div class="clause-title">第10条（損害賠償）</div>
            <div class="indent-1">違反により損害を与えた場合、民法に従い賠償する。</div>
            <div class="clause-title">第11条（解除）</div>
            <div class="indent-1">相当期間の催告をもって解除できる。破産等の場合は無催告で解除できる。</div>
            <div class="page-num">2 / 3</div>
        </div>

        <div class="a4-page">
            <div class="clause-title">第12条（不可抗力）</div>
            <div class="indent-1">天災等、乙の責に帰さない事由による遅延は、乙はその責を負わない。</div>
            <div class="clause-title">第13条〜第16条</div>
            <div class="indent-1">（秘密保持、権利譲渡禁止、協議解決、合意管轄についての規定）</div>

            <div style="margin-top: 15mm;">以上の合意を証するため、本契約書2通を作成し、甲乙各1通ずつ保有する。</div>

            <div class="sign-area">
                <div style="margin-bottom:5px;">令和　　年　　月　　日</div>
                <div>甲（発注者）</div>
                <div class="sign-row"><div class="sign-label">住　　所：</div><div class="sign-data"><span id="s_ko_addr"></span></div></div>
                <div class="sign-row"><div class="sign-label">氏　　名：</div><div class="sign-data"><span id="s_ko_name"></span></div><div class="seal-mark">印</div></div>

                <div style="margin-top: 15mm;">乙（施工者）</div>
                <div class="sign-row"><div class="sign-label">住　　所：</div><div class="sign-data"><span id="s_otsu_addr"></span></div></div>
                <div class="sign-row"><div class="sign-label">氏　　名：</div><div class="sign-data"><span id="s_otsu_name"></span></div><div class="seal-mark">印</div></div>
            </div>
            <div class="page-num">3 / 3</div>
        </div>
    </div>
</div>

<script>
    function copyKoAddr() { document.getElementById('work_place').value = document.getElementById('ko_addr').value; }
    
    function formatDateJP(dateStr) {
        if (!dateStr) return "令和　年　月　日";
        const d = new Date(dateStr);
        return `令和 ${d.getFullYear() - 2018} 年 ${d.getMonth() + 1} 月 ${d.getDate()} 日`;
    }

    function showPreview() {
        const fields = ['ko_name', 'ko_addr', 'otsu_name', 'otsu_addr', 'work_name', 'work_place', 'work_desc'];
        fields.forEach(f => {
            const val = document.getElementById(f).value;
            if(document.getElementById('p_'+f)) document.getElementById('p_'+f).innerText = val;
            if(document.getElementById('s_'+f)) document.getElementById('s_'+f).innerText = val;
        });
        document.getElementById('p_date_start').innerText = formatDateJP(document.getElementById('date_start').value);
        document.getElementById('p_date_end').innerText = formatDateJP(document.getElementById('date_end').value);
        document.getElementById('p_date_delivery').innerText = formatDateJP(document.getElementById('date_delivery').value);
        document.getElementById('p_total_price').innerText = Number(document.getElementById('total_price').value).toLocaleString();

        document.getElementById('input-screen').style.display = 'none';
        document.getElementById('preview-screen').style.display = 'block';
        window.scrollTo(0, 0);
    }

    function backToEdit() {
        document.getElementById('input-screen').style.display = 'block';
        document.getElementById('preview-screen').style.display = 'none';
    }

    async function generatePDF() {
        const element = document.getElementById('content-to-export');
        const opt = {
            margin: 0,
            filename: '工事請負契約書_' + document.getElementById('ko_name').value + '.pdf',
            image: { type: 'jpeg', quality: 1.0 },
            html2canvas: { scale: 3, useCORS: true, letterRendering: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait', compress: true }
        };
        await html2pdf().set(opt).from(element).save();
    }
</script>
</body>
</html>
