<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RSW DX PORTAL â€” æ–½å·¥å ±å‘ŠLPã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
/* =============================================
   å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  UI
============================================= */
:root {
  --gold: #b8955a;
  --gold-light: #d4b07a;
  --gold-pale: #e8d5b0;
  --bg: #080808;
  --surface: #111111;
  --surface2: #181818;
  --border: #2a2a2a;
  --border2: #333;
  --text: #e8e8e8;
  --text-muted: #666;
  --red: #c0392b;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--bg); color: var(--text); font-family: 'Helvetica Neue', Arial, sans-serif; min-height: 100vh; }

/* ãƒ˜ãƒƒãƒ€ãƒ¼ */
.portal-header {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 16px 24px;
  display: flex;
  align-items: center;
  gap: 14px;
  position: sticky;
  top: 0;
  z-index: 100;
}
.portal-logo-mark {
  width: 36px; height: 36px;
  border: 2px solid var(--gold);
  border-radius: 4px;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.65rem; font-weight: 900; color: var(--gold); letter-spacing: 0.05em;
  flex-shrink: 0;
}
.portal-logo-text { line-height: 1.2; }
.portal-logo-text .t1 { font-size: 0.6rem; color: var(--gold); letter-spacing: 0.2em; font-weight: 700; }
.portal-logo-text .t2 { font-size: 0.82rem; color: var(--text); font-weight: 600; letter-spacing: 0.05em; }

/* ãƒ•ã‚©ãƒ¼ãƒ ãƒ©ãƒƒãƒ‘ãƒ¼ */
.form-wrap { max-width: 640px; margin: 0 auto; padding: 28px 20px 60px; }

/* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.sec { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 16px; }
.sec-title {
  font-size: 0.65rem; font-weight: 800; letter-spacing: 0.18em; color: var(--gold);
  text-transform: uppercase; display: flex; align-items: center; gap: 8px; margin-bottom: 16px;
}
.sec-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }

/* ãƒ•ã‚©ãƒ¼ãƒ ãƒ‘ãƒ¼ãƒ„ */
label { display: block; font-size: 0.72rem; color: var(--text-muted); margin-bottom: 5px; margin-top: 12px; letter-spacing: 0.05em; }
label:first-of-type { margin-top: 0; }
input[type="text"], input[type="date"], input[type="tel"], input[type="url"], textarea, select {
  width: 100%; padding: 11px 14px; background: var(--bg); border: 1px solid var(--border2);
  color: var(--text); border-radius: 8px; font-size: 15px; transition: border-color 0.2s;
  -webkit-appearance: none; appearance: none;
}
input:focus, textarea:focus, select:focus { outline: none; border-color: var(--gold); }
textarea { height: 80px; resize: vertical; }
select { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23666' stroke-width='1.5' fill='none'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 36px; cursor: pointer; }

.two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.three-col { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

/* ãƒ†ãƒ¼ãƒã‚«ãƒ¼ãƒ‰ */
.theme-card {
  border: 1px solid var(--border2); border-radius: 10px; padding: 10px 8px;
  text-align: center; cursor: pointer; transition: all 0.2s; position: relative;
}
.theme-card.selected { border-color: var(--gold); box-shadow: 0 0 0 1px var(--gold); }
.theme-card .check {
  position: absolute; top: 6px; right: 6px; width: 16px; height: 16px;
  background: var(--gold); border-radius: 50%; display: none;
  align-items: center; justify-content: center; font-size: 9px; color: #000;
}
.theme-card.selected .check { display: flex; }
.theme-swatch { height: 44px; border-radius: 6px; margin-bottom: 8px; }
.theme-label { font-size: 0.7rem; font-weight: 700; letter-spacing: 0.1em; }
.theme-sub { font-size: 0.62rem; color: var(--text-muted); margin-top: 3px; }

/* ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ */
.upload-box {
  border: 1px dashed var(--border2); border-radius: 10px; padding: 20px;
  text-align: center; cursor: pointer; position: relative; overflow: hidden;
  background: var(--bg); transition: border-color 0.2s; min-height: 80px;
  display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px;
}
.upload-box:hover { border-color: var(--gold); }
.upload-box input[type="file"] { opacity: 0; position: absolute; inset: 0; cursor: pointer; }
.upload-icon { font-size: 1.4rem; }
.upload-text { font-size: 0.72rem; color: var(--text-muted); }
.upload-preview { width: 100%; max-height: 180px; object-fit: contain; border-radius: 6px; display: none; }

/* BAãƒšã‚¢ */
.ba-pair {
  background: var(--bg); border: 1px solid var(--border); border-radius: 10px;
  padding: 14px; margin-top: 12px; position: relative;
}
.ba-header { font-size: 0.65rem; color: var(--gold); font-weight: 700; letter-spacing: 0.1em; margin-bottom: 10px; }
.ba-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.ba-label { font-size: 0.65rem; font-weight: 700; letter-spacing: 0.1em; margin-bottom: 5px; color: var(--text-muted); }
.ba-remove {
  position: absolute; top: 10px; right: 10px;
  background: none; border: 1px solid #3a2020; color: var(--red);
  border-radius: 6px; padding: 3px 8px; font-size: 0.65rem; cursor: pointer;
}
.add-ba-btn {
  width: 100%; margin-top: 12px; padding: 11px; background: transparent;
  border: 1px dashed var(--border2); color: var(--text-muted);
  border-radius: 8px; cursor: pointer; font-size: 0.8rem; letter-spacing: 0.05em;
  transition: all 0.2s;
}
.add-ba-btn:hover { border-color: var(--gold); color: var(--gold); }

/* æ–‡ç« æ•´å½¢ */
.ai-row { display: flex; gap: 10px; align-items: flex-start; }
.ai-row textarea { flex: 1; }
.btn-refine {
  flex-shrink: 0; background: var(--surface2); border: 1px solid var(--border2);
  color: var(--gold-light); border-radius: 8px; padding: 10px 12px;
  font-size: 0.72rem; font-weight: 700; cursor: pointer; line-height: 1.4;
  white-space: nowrap; transition: all 0.2s; text-align: center;
}
.btn-refine:hover { background: var(--gold); color: #000; border-color: var(--gold); }
.hint { font-size: 0.7rem; color: var(--text-muted); margin-top: 6px; line-height: 1.6; }

/* ãŠå•ã„åˆã‚ã› */
.contact-row { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
.contact-row:first-of-type { margin-top: 0; }
.contact-icon { font-size: 1.1rem; flex-shrink: 0; width: 28px; text-align: center; }
.contact-row input { margin: 0; flex: 1; }

/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
.btn-line {
  width: 100%; padding: 14px; background: #06c755; color: #fff; border: none;
  border-radius: 10px; font-weight: 700; font-size: 0.95rem; cursor: pointer;
  margin-top: 20px; display: flex; align-items: center; justify-content: center; gap: 8px;
  transition: opacity 0.2s;
}
.btn-line:hover { opacity: 0.9; }
.btn-zip {
  width: 100%; padding: 16px; margin-top: 12px;
  background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 100%);
  color: #000; border: none; border-radius: 50px; font-weight: 800;
  font-size: 1rem; cursor: pointer; letter-spacing: 0.05em;
  box-shadow: 0 4px 20px rgba(184,149,90,0.35); transition: transform 0.15s, box-shadow 0.15s;
}
.btn-zip:hover { transform: translateY(-1px); box-shadow: 0 6px 24px rgba(184,149,90,0.45); }
.btn-zip:active { transform: scale(0.98); }
.btn-zip:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }


.btn-preview {
  width: 100%; padding: 14px; margin-top: 12px;
  background: transparent; border: 1px solid var(--gold);
  color: var(--gold); border-radius: 50px; font-weight: 700;
  font-size: 0.95rem; cursor: pointer; letter-spacing: 0.05em;
  transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
}
.btn-preview:hover { background: var(--gold); color: #000; }
.zip-note { text-align: center; font-size: 0.7rem; color: var(--text-muted); margin-top: 8px; line-height: 1.6; }

/* ZIPæ§‹é€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
.zip-tree {
  background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
  padding: 12px 14px; font-family: monospace; font-size: 0.72rem; line-height: 2;
  color: var(--text-muted); margin-top: 14px;
}
.zip-tree .folder { color: #6cf; }
.zip-tree .file-h { color: #aef; }
.zip-tree .file-i { color: #9f9; }
</style>
</head>
<body>

<header class="portal-header">
  <div class="portal-logo-mark">RSW</div>
  <div class="portal-logo-text">
    <div class="t1">ROLLER STONE / ROLLER WALL</div>
    <div class="t2">æ–½å·¥å ±å‘Š LP ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</div>
  </div>
</header>

<div class="form-wrap">

  <!-- åŸºæœ¬æƒ…å ± -->
  <div class="sec">
    <div class="sec-title">åŸºæœ¬æƒ…å ±</div>
    <label>æ–½å·¥å®Œäº†æ—¥</label>
    <input type="date" id="date">
    <div class="two-col" style="margin-top:12px;">
      <div>
        <label>éƒ½é“åºœçœŒ</label>
        <select id="prefecture">
          <option value="">é¸æŠ</option>
          <option>åŒ—æµ·é“</option><option>é’æ£®çœŒ</option><option>å²©æ‰‹çœŒ</option><option>å®®åŸçœŒ</option>
          <option>ç§‹ç”°çœŒ</option><option>å±±å½¢çœŒ</option><option>ç¦å³¶çœŒ</option><option>èŒ¨åŸçœŒ</option>
          <option>æ ƒæœ¨çœŒ</option><option>ç¾¤é¦¬çœŒ</option><option>åŸ¼ç‰çœŒ</option><option>åƒè‘‰çœŒ</option>
          <option>æ±äº¬éƒ½</option><option>ç¥å¥ˆå·çœŒ</option><option>æ–°æ½ŸçœŒ</option><option>å¯Œå±±çœŒ</option>
          <option>çŸ³å·çœŒ</option><option>ç¦äº•çœŒ</option><option>å±±æ¢¨çœŒ</option><option>é•·é‡çœŒ</option>
          <option>å²é˜œçœŒ</option><option>é™å²¡çœŒ</option><option>æ„›çŸ¥çœŒ</option><option>ä¸‰é‡çœŒ</option>
          <option>æ»‹è³€çœŒ</option><option>äº¬éƒ½åºœ</option><option>å¤§é˜ªåºœ</option><option>å…µåº«çœŒ</option>
          <option>å¥ˆè‰¯çœŒ</option><option>å’Œæ­Œå±±çœŒ</option><option>é³¥å–çœŒ</option><option>å³¶æ ¹çœŒ</option>
          <option>å²¡å±±çœŒ</option><option>åºƒå³¶çœŒ</option><option>å±±å£çœŒ</option><option>å¾³å³¶çœŒ</option>
          <option>é¦™å·çœŒ</option><option>æ„›åª›çœŒ</option><option>é«˜çŸ¥çœŒ</option><option>ç¦å²¡çœŒ</option>
          <option>ä½è³€çœŒ</option><option>é•·å´çœŒ</option><option>ç†Šæœ¬çœŒ</option><option>å¤§åˆ†çœŒ</option>
          <option>å®®å´çœŒ</option><option>é¹¿å…å³¶çœŒ</option><option>æ²–ç¸„çœŒ</option>
        </select>
      </div>
      <div>
        <label>èªå®šæ–½å·¥åº—å</label>
        <input type="text" id="shopName" placeholder="ä¾‹ï¼šå±±ç”°å¤–æ§‹å·¥äº‹åº—">
      </div>
    </div>
  </div>

  <!-- LPãƒ†ãƒ¼ãƒ -->
  <div class="sec">
    <div class="sec-title">LP ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ</div>
    <div class="three-col">
      <div class="theme-card selected" onclick="selectTheme('luxury',this)">
        <div class="check">âœ“</div>
        <div class="theme-swatch" style="background:linear-gradient(160deg,#0a0a0a,#1c1400);border:1px solid #b8955a;"></div>
        <div class="theme-label" style="color:#b8955a;">LUXURY</div>
        <div class="theme-sub">é»’ Ã— ã‚´ãƒ¼ãƒ«ãƒ‰</div>
      </div>
      <div class="theme-card" onclick="selectTheme('natural',this)">
        <div class="check">âœ“</div>
        <div class="theme-swatch" style="background:linear-gradient(160deg,#f0ebe0,#ddd0bb);"></div>
        <div class="theme-label" style="color:#7a6040;">NATURAL</div>
        <div class="theme-sub">ãƒ™ãƒ¼ã‚¸ãƒ¥ Ã— èŒ¶</div>
      </div>
      <div class="theme-card" onclick="selectTheme('cool',this)">
        <div class="check">âœ“</div>
        <div class="theme-swatch" style="background:linear-gradient(160deg,#0a1520,#112035);border:1px solid #3a80c0;"></div>
        <div class="theme-label" style="color:#5aaae0;">COOL</div>
        <div class="theme-sub">ãƒã‚¤ãƒ“ãƒ¼ Ã— é’</div>
      </div>
    </div>
    <input type="hidden" id="selectedTheme" value="luxury">
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ç”»åƒ -->
  <div class="sec">
    <div class="sec-title">ãƒ¡ã‚¤ãƒ³å®Œäº†å†™çœŸ</div>
    <div class="upload-box" id="box-imgMain">
      <span class="upload-icon">ğŸ“·</span>
      <span class="upload-text">ã‚¿ãƒƒãƒ—ã—ã¦å®Œäº†å†™çœŸã‚’é¸æŠ</span>
      <input type="file" id="imgMain" accept="image/*" onchange="previewFile('imgMain')">
      <img class="upload-preview" id="preview-imgMain">
    </div>
  </div>

  <!-- Before / After -->
  <div class="sec">
    <div class="sec-title">Before / After</div>
    <div id="baPairsContainer"></div>
    <button class="add-ba-btn" onclick="addBaPair()">ï¼‹ Before / After ã‚’è¿½åŠ </button>
  </div>

  <!-- æ–½å·¥é¢¨æ™¯ -->
  <div class="sec">
    <div class="sec-title">æ–½å·¥é¢¨æ™¯ / é›†åˆå†™çœŸ <span style="font-weight:400;color:var(--text-muted);">ï¼ˆä»»æ„ï¼‰</span></div>
    <div class="upload-box" id="box-imgSub">
      <span class="upload-icon">ğŸ“·</span>
      <span class="upload-text">ã‚¿ãƒƒãƒ—ã—ã¦å†™çœŸã‚’é¸æŠ</span>
      <input type="file" id="imgSub" accept="image/*" onchange="previewFile('imgSub')">
      <img class="upload-preview" id="preview-imgSub">
    </div>
  </div>

  <!-- ã“ã ã‚ã‚Šãƒã‚¤ãƒ³ãƒˆ -->
  <div class="sec">
    <div class="sec-title">æ–½å·¥ã®ã“ã ã‚ã‚Šãƒã‚¤ãƒ³ãƒˆ</div>
    <div class="hint">ğŸ’¡ æ–½å·¥ã®ãƒã‚¤ãƒ³ãƒˆã‚’å˜èªã‚„çŸ­æ–‡ã§OKï¼ˆä¾‹ï¼šç›®åœ°ã®ç²¾åº¦ã€ç´ æã®è³ªæ„Ÿã€æ®µå·®å‡¦ç†ã€é¤Šç”Ÿã®ä¸å¯§ã•ï¼‰<br>â†’ å³ã®ã€Œæ•´ãˆã‚‹ã€ã§æ–½å·¥è€…ç›®ç·šã®æ–‡ç« ã«è‡ªå‹•å¤‰æ›ã—ã¾ã™</div>
    <div class="ai-row" style="margin-top:10px;">
      <textarea id="kodawari" placeholder="ä¾‹ï¼šç›®åœ°ãŒç¶ºéº—ã€é¤Šç”Ÿä¸å¯§ã€æ®µå·®ãªã—ã€è‰²ãŒæ˜ ãˆã‚‹"></textarea>
      <button class="btn-refine" onclick="optimizeText('kodawari')">âœ¦ æ–‡ç« ã‚’<br>æ•´ãˆã‚‹</button>
    </div>
  </div>

  <!-- æ–½å·¥è©³ç´° -->
  <div class="sec">
    <div class="sec-title">æ–½å·¥ãƒ‡ãƒ¼ã‚¿</div>
    <div class="two-col">
      <div><label>æ–½å·¥é¢ç©ï¼ˆã¡ï¼‰</label><input type="text" id="area" placeholder="ä¾‹ï¼š28"></div>
      <div><label>æ–½å·¥æ—¥æ•°ï¼ˆæ—¥ï¼‰</label><input type="text" id="days" placeholder="ä¾‹ï¼š3"></div>
    </div>
    <div class="two-col" style="margin-top:12px;">
      <div><label>ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼</label><input type="text" id="colorMain" placeholder="ä¾‹ï¼šãƒŸãƒ«ã‚¯ãƒ†ã‚£ãƒ¼"></div>
      <div><label>ç›®åœ°ã‚«ãƒ©ãƒ¼</label><input type="text" id="colorJoint" placeholder="ä¾‹ï¼šãƒ–ãƒ©ãƒƒã‚¯"></div>
    </div>
  </div>

  <!-- ãŠå®¢æ§˜ã®å£° -->
  <div class="sec">
    <div class="sec-title">ãŠå®¢æ§˜ã®å£°</div>
    <div class="hint">ğŸ’¡ ãŠå®¢æ§˜ã‹ã‚‰ã„ãŸã ã„ãŸè¨€è‘‰ã‚’çŸ­ãã§OKï¼ˆä¾‹ï¼šæ˜ã‚‹ããªã£ãŸã€ã‹ã£ã“ã„ã„ã€é©šã„ãŸï¼‰<br>â†’ å³ã®ã€Œæ•´ãˆã‚‹ã€ã§è‡ªç„¶ãªå£°ã«å¤‰æ›ã—ã¾ã™</div>
    <div class="ai-row" style="margin-top:10px;">
      <textarea id="voice" placeholder="ä¾‹ï¼šè¦‹ãŸç›®ãŒå¤‰ã‚ã£ã¦é©šã„ãŸã€æ˜ã‚‹ããªã£ãŸã€ã¾ãŸé ¼ã¿ãŸã„"></textarea>
      <button class="btn-refine" onclick="optimizeText('voice')">âœ¦ æ–‡ç« ã‚’<br>æ•´ãˆã‚‹</button>
    </div>
  </div>

  <!-- ãŠå•ã„åˆã‚ã› -->
  <div class="sec">
    <div class="sec-title">ãŠå•ã„åˆã‚ã›å…ˆ</div>
    <div class="hint" style="margin-bottom:10px;">å…¥åŠ›ã—ãŸã‚‚ã®ã ã‘LPã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
    <div class="contact-row"><span class="contact-icon">ğŸ’¬</span><input type="url" id="lineUrl" placeholder="LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ URL"></div>
    <div class="contact-row"><span class="contact-icon">ğŸ“¸</span><input type="url" id="instaUrl" placeholder="Instagram URL"></div>
    <div class="contact-row"><span class="contact-icon">ğŸ“</span><input type="text" id="phoneNum" placeholder="ä¾‹ï¼š090-1234-5678" inputmode="tel"></div>
  </div>

  <!-- ZIPæ§‹é€  -->
  <div class="zip-tree">
    <span class="folder">ğŸ“ report_æ—¥ä»˜_åº—å.zip</span><br>
    &nbsp;&nbsp;<span class="file-h">ğŸ“„ index.html</span> â€” æ–½å·¥äº‹ä¾‹ LP<br>
    &nbsp;&nbsp;<span class="file-i">ğŸ–¼ main.jpg</span> â€” ãƒ¡ã‚¤ãƒ³å†™çœŸï¼ˆSNSç´ æï¼‰<br>
    &nbsp;&nbsp;<span class="file-i">ğŸ–¼ before_1.jpg / after_1.jpg â€¦</span> â€” BAå†™çœŸ<br>
    &nbsp;&nbsp;<span class="file-i">ğŸ–¼ sub.jpg</span> â€” æ–½å·¥é¢¨æ™¯ï¼ˆä»»æ„ï¼‰
  </div>

  <button class="btn-line" onclick="copyLineText()">ğŸ’¬ LINEå ±å‘Šãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
  <button class="btn-preview" onclick="openPreview()">ğŸ‘ LP ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç¢ºèªã™ã‚‹</button>
  <button class="btn-zip" id="generateZipBtn" onclick="generateZip()">ğŸ“¦ æ–½å·¥äº‹ä¾‹ LP ã‚’ç”Ÿæˆï¼ˆZIPï¼‰</button>
  <p class="zip-note">æœ¬éƒ¨ã¸LINEã§é€ä¿¡ã™ã‚‹ZIPãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™<br>åŒæ¢±ã®index.htmlã¯æ–½å·¥åº—ã®SNSãƒ»åºƒå‘Šã«ã‚‚ãã®ã¾ã¾æ´»ç”¨ã§ãã¾ã™</p>

</div><!-- /form-wrap -->

<!-- ===== ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
<div id="previewModal" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.92);flex-direction:column;">
  <div style="background:#111;border-bottom:1px solid #2a2a2a;padding:12px 16px;display:flex;align-items:center;gap:12px;flex-shrink:0;">
    <div style="flex:1;">
      <div style="font-size:0.6rem;color:#b8955a;letter-spacing:0.15em;font-weight:700;">LP PREVIEW</div>
      <div style="font-size:0.8rem;color:#ccc;margin-top:1px;">é€ä¿¡å‰ã®ä»•ä¸ŠãŒã‚Šã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ç¢ºèª</div>
    </div>
    <div style="display:flex;gap:6px;">
      <button onclick="setPreviewDevice('sp')" id="btn-sp" style="background:#b8955a;color:#000;border:none;border-radius:6px;padding:6px 12px;font-size:0.72rem;font-weight:700;cursor:pointer;">ğŸ“± SP</button>
      <button onclick="setPreviewDevice('pc')" id="btn-pc" style="background:#222;color:#888;border:1px solid #333;border-radius:6px;padding:6px 12px;font-size:0.72rem;font-weight:700;cursor:pointer;">ğŸ–¥ PC</button>
    </div>
    <button onclick="closePreview()" style="background:#2a0000;color:#e74c3c;border:1px solid #e74c3c;border-radius:8px;padding:7px 14px;font-size:0.8rem;font-weight:700;cursor:pointer;">âœ• é–‰ã˜ã‚‹</button>
  </div>
  <div id="previewShell" style="flex:1;overflow:auto;display:flex;align-items:flex-start;justify-content:center;padding:24px 16px;background:#0a0a0a;">
    <div id="previewFrame" style="width:390px;background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 8px 40px rgba(0,0,0,0.7);transition:width 0.3s;">
      <iframe id="previewIframe" style="width:100%;height:80vh;border:none;display:block;"></iframe>
    </div>
  </div>
  <div style="background:#111;border-top:1px solid #2a2a2a;padding:14px 16px;display:flex;gap:10px;flex-shrink:0;">
    <button onclick="closePreview();setTimeout(generateZip,200);" style="flex:1;padding:14px;background:linear-gradient(135deg,#b8955a,#d4b07a);color:#000;border:none;border-radius:50px;font-weight:800;font-size:0.95rem;cursor:pointer;">ğŸ“¦ ã“ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã§ZIPã‚’ç”Ÿæˆã™ã‚‹</button>
    <button onclick="closePreview()" style="padding:14px 18px;background:#1a1a1a;border:1px solid #333;color:#888;border-radius:50px;font-size:0.85rem;cursor:pointer;">ä¿®æ­£ã™ã‚‹</button>
  </div>
</div>

<script>
// =======================================
//  åˆæœŸåŒ–
// =======================================
window.onload = function() {
  var p = new URLSearchParams(window.location.search);
  if (p.has('shop')) document.getElementById('shopName').value = p.get('shop');
  if (p.has('line')) document.getElementById('lineUrl').value  = p.get('line');
  document.getElementById('date').valueAsDate = new Date();
  addBaPair();
};

// =======================================
//  ãƒ†ãƒ¼ãƒé¸æŠ
// =======================================
function selectTheme(name, el) {
  document.querySelectorAll('.theme-card').forEach(function(c){ c.classList.remove('selected'); });
  el.classList.add('selected');
  document.getElementById('selectedTheme').value = name;
}

// =======================================
//  ãƒ“ãƒ•ã‚©ãƒ¼ã‚¢ãƒ•ã‚¿ãƒ¼ç®¡ç†
// =======================================
var baPairCount = 0;
var baPairImages = {};

function addBaPair() {
  baPairCount++;
  var id = baPairCount;
  var div = document.createElement('div');
  div.className = 'ba-pair';
  div.id = 'baPair_' + id;
  div.innerHTML =
    '<div class="ba-header">PAIR ' + String(id).padStart(2,'0') + '</div>' +
    (id > 1 ? '<button class="ba-remove" onclick="removeBaPair(' + id + ')">âœ• å‰Šé™¤</button>' : '') +
    '<div class="ba-grid">' +
      '<div>' +
        '<div class="ba-label">BEFORE</div>' +
        '<div class="upload-box">' +
          '<span class="upload-icon" style="font-size:1rem;">ğŸ“·</span>' +
          '<span class="upload-text">é¸æŠ</span>' +
          '<input type="file" accept="image/*" onchange="previewBaFile(\'before\',' + id + ',this)">' +
          '<img class="upload-preview" id="preview-before_' + id + '">' +
        '</div>' +
      '</div>' +
      '<div>' +
        '<div class="ba-label">AFTER</div>' +
        '<div class="upload-box">' +
          '<span class="upload-icon" style="font-size:1rem;">ğŸ“·</span>' +
          '<span class="upload-text">é¸æŠ</span>' +
          '<input type="file" accept="image/*" onchange="previewBaFile(\'after\',' + id + ',this)">' +
          '<img class="upload-preview" id="preview-after_' + id + '">' +
        '</div>' +
      '</div>' +
    '</div>';
  document.getElementById('baPairsContainer').appendChild(div);
}

function removeBaPair(id) {
  var el = document.getElementById('baPair_' + id);
  if (el) el.remove();
  delete baPairImages['before_' + id];
  delete baPairImages['after_' + id];
}

function previewBaFile(type, id, input) {
  var file = input.files[0];
  if (!file) return;
  var key = type + '_' + id;
  compressAndStore(file, key, function(dataUrl) {
    var prev = document.getElementById('preview-' + key);
    prev.src = dataUrl;
    prev.style.display = 'block';
    var box = prev.closest('.upload-box');
    box.querySelector('.upload-icon').style.display = 'none';
    box.querySelector('.upload-text').style.display = 'none';
  }, baPairImages);
}

// =======================================
//  å˜ä½“ç”»åƒ
// =======================================
var singleImages = {};
function previewFile(id) {
  var file = document.getElementById(id).files[0];
  if (!file) return;
  compressAndStore(file, id, function(dataUrl) {
    var prev = document.getElementById('preview-' + id);
    prev.src = dataUrl;
    prev.style.display = 'block';
    var box = document.getElementById('box-' + id) || prev.closest('.upload-box');
    if (box) {
      box.querySelector('.upload-icon').style.display = 'none';
      box.querySelector('.upload-text').style.display = 'none';
    }
  }, singleImages);
}

function compressAndStore(file, key, cb, store) {
  var reader = new FileReader();
  reader.onload = function(e) {
    var img = new Image();
    img.onload = function() {
      var MAX = 1400; var w = img.width, h = img.height;
      if (w > MAX) { h = Math.round(h * MAX / w); w = MAX; }
      var canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      var dataUrl = canvas.toDataURL('image/jpeg', 0.88);
      store[key] = dataUrl;
      cb(dataUrl);
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// =======================================
//  æ–‡ç« æ•´å½¢è¾æ›¸
// =======================================
var kodawariDict = {
  'ç›®åœ°ãŒç¶ºéº—': 'ç›®åœ°ãƒ©ã‚¤ãƒ³ã‚’ä¸€æœ¬ä¸€æœ¬ä¸å¯§ã«æ•´ãˆã€è·äººã®æŠ€è¡“ãŒå…‰ã‚‹ä»•ä¸ŠãŒã‚Šã‚’å®Ÿç¾ã—ã¾ã—ãŸã€‚',
  'ç›®åœ°ãŒç¶ºéº—': 'ç›®åœ°ãƒ©ã‚¤ãƒ³ã‚’ä¸€æœ¬ä¸€æœ¬ä¸å¯§ã«æ•´ãˆã€è·äººã®æŠ€è¡“ãŒå…‰ã‚‹ä»•ä¸ŠãŒã‚Šã‚’å®Ÿç¾ã—ã¾ã—ãŸã€‚',
  'ç›®åœ°ã®ç²¾åº¦': 'ç›®åœ°ãƒ©ã‚¤ãƒ³ã®ç²¾åº¦ã«ã¨ã“ã¨ã‚“ã“ã ã‚ã‚Šã€å‡ä¸€ã§ç¾ã—ã„ã‚¹ãƒˆãƒ¼ãƒ³èª¿ã®è¡¨æƒ…ã‚’å‡ºã—ã¾ã—ãŸã€‚',
  'ç›®åœ°': 'ç›®åœ°ã®ãƒ©ã‚¤ãƒ³ã‚’å‡ä¸€ã«ä»•ä¸Šã’ã‚‹ã“ã¨ã§ã€æœ¬ç‰©ã®çŸ³å¼µã‚Šã«è¿«ã‚‹è³ªæ„Ÿã‚’å®Ÿç¾ã—ã¾ã—ãŸã€‚',
  'é¤Šç”ŸãŒä¸å¯§': 'æ—¢å­˜éƒ¨åˆ†ã‚’å¾¹åº•çš„ã«é¤Šç”Ÿã—ã€å‘¨è¾ºã‚’å‚·ã¤ã‘ã‚‹ã“ã¨ãªãç¾ã—ãä»•ä¸Šã’ã¾ã—ãŸã€‚',
  'é¤Šç”Ÿä¸å¯§': 'æ—¢å­˜éƒ¨åˆ†ã‚’å¾¹åº•çš„ã«é¤Šç”Ÿã—ã€å‘¨è¾ºã‚’å‚·ã¤ã‘ã‚‹ã“ã¨ãªãç¾ã—ãä»•ä¸Šã’ã¾ã—ãŸã€‚',
  'é¤Šç”Ÿ': 'æ–½å·¥å‰ã®å¾¹åº•ã—ãŸé¤Šç”Ÿã«ã‚ˆã‚Šã€æ—¢å­˜ç®‡æ‰€ã¸ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸€åˆ‡ä¸ãˆã‚‹ã“ã¨ãªãå®Œå·¥ã—ã¾ã—ãŸã€‚',
  'æ®µå·®ãªã—': 'æ®µå·®ã‚¼ãƒ­ã®æ–½å·¥ã«ã“ã ã‚ã‚Šã€ãƒãƒªã‚¢ãƒ•ãƒªãƒ¼ã§å®‰å…¨ãªä»•ä¸ŠãŒã‚Šã‚’å®Ÿç¾ã—ã¾ã—ãŸã€‚',
  'æ®µå·®å‡¦ç†': 'æ—¢å­˜é¢ã¨ã®æ®µå·®ã‚’ä¸å¯§ã«èª¿æ•´ã—ã€ãƒ•ãƒ©ãƒƒãƒˆã§é•å’Œæ„Ÿã®ãªã„ä»•ä¸ŠãŒã‚Šã«ã—ã¾ã—ãŸã€‚',
  'è‰²ãŒæ˜ ãˆã‚‹': 'ç´ ææœ¬æ¥ã®è‰²å‘³ã‚’æœ€å¤§é™ã«å¼•ãå‡ºã—ã€å…‰ã®å½“ãŸã‚Šæ–¹ã«ã‚ˆã£ã¦è¡¨æƒ…ãŒå¤‰ã‚ã‚‹ç¾ã—ã„ä»•ä¸ŠãŒã‚Šã§ã™ã€‚',
  'è‰²ãŒé®®ã‚„ã‹': 'é®®ã‚„ã‹ãªç™ºè‰²ãŒç©ºé–“ã«ãƒ¡ãƒªãƒãƒªã‚’ã‚‚ãŸã‚‰ã—ã€ä¸€ç›®ã§ç›®ã‚’å¼•ããƒ‡ã‚¶ã‚¤ãƒ³ã«ä»•ä¸Šã’ã¾ã—ãŸã€‚',
  'ç´ æã®è³ªæ„Ÿ': 'ç´ æã®æŒã¤è‡ªç„¶ãªå‡¹å‡¸ã¨è³ªæ„Ÿã‚’ãƒªã‚¢ãƒ«ã«å†ç¾ã—ã€ã¾ã‚‹ã§æœ¬ç‰©ã®ã‚¹ãƒˆãƒ¼ãƒ³ã®ã‚ˆã†ãªå­˜åœ¨æ„Ÿã‚’å‡ºã—ã¾ã—ãŸã€‚',
  'è³ªæ„ŸãŒã„ã„': 'ç‰¹æ®Šå·¥æ³•ã«ã‚ˆã‚‹ãƒªã‚¢ãƒ«ãªçŸ³ç›®ã®è³ªæ„Ÿã§ã€é«˜ç´šæ„Ÿã‚ãµã‚Œã‚‹ç©ºé–“ã«ä»•ä¸ŠãŒã‚Šã¾ã—ãŸã€‚',
  'ä»•ä¸ŠãŒã‚ŠãŒç¶ºéº—': 'ç´°éƒ¨ã¾ã§å¦¥å”ãªãä»•ä¸Šã’ã€æ–½å·¥å¾Œã®ç¾ã—ã•ãŒé•·æœŸé–“æŒç¶šã™ã‚‹å“è³ªã‚’å®Ÿç¾ã—ã¾ã—ãŸã€‚',
  'ä¸å¯§': 'ä¸‹åœ°å‡¦ç†ã‹ã‚‰ä»•ä¸Šã’ã¾ã§ã€ä¸€å·¥ç¨‹ä¸€å·¥ç¨‹ã‚’ä¸å¯§ã«æ–½å·¥ã™ã‚‹ã“ã¨ã§é«˜ã„å®Œæˆåº¦ã‚’è¿½æ±‚ã—ã¾ã—ãŸã€‚',
  'æ—©ã„': 'åŠ¹ç‡çš„ãªæ–½å·¥è¨ˆç”»ã¨ç†Ÿç·´ã®æŠ€è¡“ã§ã€å“è³ªã‚’ä¿ã¡ãªãŒã‚‰ã‚¹ãƒ”ãƒ¼ãƒ‡ã‚£ã«æ–½å·¥ã‚’å®Œäº†ã—ã¾ã—ãŸã€‚',
  'å¼·ã„': 'è€ä¹…æ€§ã«å„ªã‚ŒãŸå°‚ç”¨ææ–™ã¨æ–½å·¥æŠ€è¡“ã§ã€é•·æœŸã«ã‚ãŸã£ã¦ç¾ã—ã•ãŒæŒç¶šã™ã‚‹ä»•ä¸ŠãŒã‚Šã§ã™ã€‚',
  'ãŠã—ã‚ƒã‚Œ': 'ãƒ‡ã‚¶ã‚¤ãƒ³æ€§ã¨æ©Ÿèƒ½æ€§ã‚’ä¸¡ç«‹ã—ã€å‘¨å›²ã®æ™¯è¦³ã¨èª¿å’Œã—ãŸæ´—ç·´ã•ã‚ŒãŸç©ºé–“ã‚’å®Ÿç¾ã—ã¾ã—ãŸã€‚',
  'ç¶ºéº—': 'ç´°éƒ¨ã¾ã§ä¸å¯§ã«æ–½å·¥ã—ã€æœ¬ç‰©ã®ã‚¿ã‚¤ãƒ«ãƒ»çŸ³å¼µã‚Šã«è¿«ã‚‹ç¾ã—ã„ä»•ä¸ŠãŒã‚Šã‚’å®Ÿç¾ã—ã¾ã—ãŸã€‚',
  'ãã‚Œã„': 'ç´°éƒ¨ã¾ã§ä¸å¯§ã«æ–½å·¥ã—ã€æœ¬ç‰©ã®ã‚¿ã‚¤ãƒ«ãƒ»çŸ³å¼µã‚Šã«è¿«ã‚‹ç¾ã—ã„ä»•ä¸ŠãŒã‚Šã‚’å®Ÿç¾ã—ã¾ã—ãŸã€‚'
};

var voiceDict = {
  'æ˜ã‚‹ããªã£ãŸ': 'ã€Œæ–½å·¥å¾Œã€ç„é–¢ã¾ã‚ã‚ŠãŒã‚¬ãƒ©ãƒƒã¨æ˜ã‚‹ããªã£ã¦ã€æ¯æ—¥å¸°ã£ã¦ãã‚‹ã®ãŒæ¥½ã—ã¿ã«ãªã‚Šã¾ã—ãŸã€‚ã€',
  'æ˜ã‚‹ããªã‚Š': 'ã€Œæ–½å·¥å¾Œã€ç„é–¢ã¾ã‚ã‚ŠãŒã‚¬ãƒ©ãƒƒã¨æ˜ã‚‹ããªã£ã¦ã€æ¯æ—¥å¸°ã£ã¦ãã‚‹ã®ãŒæ¥½ã—ã¿ã«ãªã‚Šã¾ã—ãŸã€‚ã€',
  'æ˜ã‚‹ã„': 'ã€Œã“ã‚“ãªã«é›°å›²æ°—ãŒå¤‰ã‚ã‚‹ã¨ã¯æ€ã‚ãªã‹ã£ãŸã€‚å®¶å…¨ä½“ãŒæ˜ã‚‹ãè¦‹ãˆã¾ã™ã€‚ã€',
  'ã‹ã£ã“ã‚ˆããªã£ãŸ': 'ã€Œæƒ³åƒä»¥ä¸Šã«ã‹ã£ã“ã‚ˆããªã£ã¦ã€è¿‘æ‰€ã®æ–¹ã«ã‚‚è¤’ã‚ã¦ã‚‚ã‚‰ã„ã¾ã—ãŸï¼ã€',
  'ã‹ã£ã“ã‚ˆã‹ã£ãŸ': 'ã€Œå®Œæˆã‚’è¦‹ã¦ã€æ€ã‚ãšå£°ãŒå‡ºã‚‹ã»ã©ã‹ã£ã“ã‚ˆã‹ã£ãŸã§ã™ã€‚å¤§æº€è¶³ã§ã™ã€‚ã€',
  'ã‹ã£ã“ã„ã„': 'ã€Œä»•ä¸ŠãŒã‚Šã‚’è¦‹ãŸç¬é–“ã€ã“ã‚Œã¯ã™ã”ã„ã¨æ€ã„ã¾ã—ãŸã€‚æœ¬å½“ã«ã‹ã£ã“ã„ã„ã§ã™ã€‚ã€',
  'ã‹ã£ã“ã‚ˆ': 'ã€Œå®Œæˆã‚’è¦‹ã¦ã€æ€ã‚ãšå£°ãŒå‡ºã‚‹ã»ã©ã‹ã£ã“ã‚ˆã‹ã£ãŸã§ã™ã€‚å¤§æº€è¶³ã§ã™ã€‚ã€',
  'é©šã„ãŸ': 'ã€Œæ–½å·¥å‰ã¨æ–½å·¥å¾Œã®å¤‰åŒ–ã«æ­£ç›´é©šãã¾ã—ãŸã€‚ã“ã‚“ãªã«å¤‰ã‚ã‚‹ã‚‚ã®ãªã‚“ã§ã™ã­ã€‚ã€',
  'ã³ã£ãã‚Š': 'ã€Œæ–½å·¥å‰ã¨æ–½å·¥å¾Œã®å¤‰åŒ–ã«æ­£ç›´é©šãã¾ã—ãŸã€‚ã“ã‚“ãªã«å¤‰ã‚ã‚‹ã‚‚ã®ãªã‚“ã§ã™ã­ã€‚ã€',
  'å–œã‚“ã§ã„ãŸ': 'ã€Œå®¶æ—å…¨å“¡ãŒå¤§å–œã³ã—ã¦ã„ã¾ã—ãŸã€‚ã‚„ã£ã¦ã‚ˆã‹ã£ãŸã¨å¿ƒã‹ã‚‰æ€ã£ã¦ã„ã¾ã™ã€‚ã€',
  'å–œã‚“ã§ãŸ': 'ã€Œå®¶æ—å…¨å“¡ãŒå¤§å–œã³ã—ã¦ã„ã¾ã—ãŸã€‚ã‚„ã£ã¦ã‚ˆã‹ã£ãŸã¨å¿ƒã‹ã‚‰æ€ã£ã¦ã„ã¾ã™ã€‚ã€',
  'å–œã‚“ã§': 'ã€Œå®¶æ—å…¨å“¡ãŒå¤§å–œã³ã—ã¦ã„ã¾ã—ãŸã€‚ã‚„ã£ã¦ã‚ˆã‹ã£ãŸã¨å¿ƒã‹ã‚‰æ€ã£ã¦ã„ã¾ã™ã€‚ã€',
  'ã¾ãŸé ¼ã¿ãŸã„': 'ã€Œæ¬¡ã«ãƒªãƒ•ã‚©ãƒ¼ãƒ ã™ã‚‹ã¨ãã‚‚ã€çµ¶å¯¾ã«ãŠé¡˜ã„ã—ãŸã„ã¨æ€ã£ã¦ã„ã¾ã™ã€‚ã€',
  'ã¾ãŸé ¼ã‚€': 'ã€Œæ¬¡ã«ãƒªãƒ•ã‚©ãƒ¼ãƒ ã™ã‚‹ã¨ãã‚‚ã€çµ¶å¯¾ã«ãŠé¡˜ã„ã—ãŸã„ã¨æ€ã£ã¦ã„ã¾ã™ã€‚ã€',
  'æº€è¶³': 'ã€ŒæœŸå¾…ä»¥ä¸Šã®å‡ºæ¥æ „ãˆã§ã€å¤§å¤‰æº€è¶³ã—ã¦ã„ã¾ã™ã€‚ãŠé¡˜ã„ã—ã¦æœ¬å½“ã«ã‚ˆã‹ã£ãŸã§ã™ã€‚ã€',
  'æ„Ÿå‹•': 'ã€Œå®Œæˆå†™çœŸã‚’è¦‹ãŸã¨ãã€æ„Ÿå‹•ã§è¨€è‘‰ãŒå‡ºã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ—ãƒ­ã®æŠ€è¡“ã¯ã™ã”ã„ã§ã™ã­ã€‚ã€',
  'ä¸å¯§': 'ã€Œæ–½å·¥ä¸­ã‚‚ã¨ã¦ã‚‚ä¸å¯§ã«å¯¾å¿œã—ã¦ã„ãŸã ãã€å®‰å¿ƒã—ã¦ãŠä»»ã›ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚ã€',
  'æ—©ã‹ã£ãŸ': 'ã€Œå·¥äº‹ãŒäºˆæƒ³ã‚ˆã‚Šæ—©ãçµ‚ã‚ã£ã¦åŠ©ã‹ã‚Šã¾ã—ãŸã€‚ç”Ÿæ´»ã¸ã®å½±éŸ¿ã‚‚æœ€å°é™ã§ã—ãŸã€‚ã€',
  'æ—©ã„': 'ã€Œå·¥äº‹ãŒäºˆæƒ³ã‚ˆã‚Šæ—©ãçµ‚ã‚ã£ã¦åŠ©ã‹ã‚Šã¾ã—ãŸã€‚ç”Ÿæ´»ã¸ã®å½±éŸ¿ã‚‚æœ€å°é™ã§ã—ãŸã€‚ã€',
  'ãã‚Œã„ã«ãªã£ãŸ': 'ã€Œè¦‹é•ãˆã‚‹ã»ã©ãã‚Œã„ã«ãªã‚Šã¾ã—ãŸã€‚æ–°ç¯‰ã¿ãŸã„ã§ã€å‹äººã«ã‚‚è‡ªæ…¢ã§ãã¾ã™ã€‚ã€',
  'ãã‚Œã„ã«': 'ã€Œè¦‹é•ãˆã‚‹ã»ã©ãã‚Œã„ã«ãªã‚Šã¾ã—ãŸã€‚æ–°ç¯‰ã¿ãŸã„ã§ã€å‹äººã«ã‚‚è‡ªæ…¢ã§ãã¾ã™ã€‚ã€',
  'ç¶ºéº—ã«ãªã£ãŸ': 'ã€Œè¦‹é•ãˆã‚‹ã»ã©ãã‚Œã„ã«ãªã‚Šã¾ã—ãŸã€‚æ–°ç¯‰ã¿ãŸã„ã§ã€å‹äººã«ã‚‚è‡ªæ…¢ã§ãã¾ã™ã€‚ã€',
  'ç¶ºéº—ã«': 'ã€Œè¦‹é•ãˆã‚‹ã»ã©ãã‚Œã„ã«ãªã‚Šã¾ã—ãŸã€‚æ–°ç¯‰ã¿ãŸã„ã§ã€å‹äººã«ã‚‚è‡ªæ…™ã§ãã¾ã™ã€‚ã€',
  'ã‚ˆã‹ã£ãŸ': 'ã€Œä»•ä¸ŠãŒã‚ŠãŒæƒ³åƒä»¥ä¸Šã§ã€æœ¬å½“ã«ã‚ˆã‹ã£ãŸã§ã™ã€‚ãŠé¡˜ã„ã—ã¦æ­£è§£ã§ã—ãŸã€‚ã€',
  'ã™ã”ã„': 'ã€Œã“ã‚“ãªã«å¤‰ã‚ã‚‹ã¨ã¯æ€ã‚ãªã‹ã£ãŸã€‚æœ¬å½“ã«ã™ã”ã„æŠ€è¡“ã§ã™ã­ã€‚ã€',
  'ãŠã—ã‚ƒã‚Œ': 'ã€Œæ–½å·¥å¾Œã«è¿‘æ‰€ã®æ–¹ã‹ã‚‰"ãŠã—ã‚ƒã‚Œã«ãªã£ãŸã­"ã¨å£°ã‚’ã‹ã‘ã¦ã‚‚ã‚‰ã„ã¾ã—ãŸã€‚ã€',
  'ã‹ã‚ã„ã„': 'ã€Œã‚¤ãƒ¡ãƒ¼ã‚¸é€šã‚Šã®ä»•ä¸ŠãŒã‚Šã§ã€æ¯æ—¥è¦‹ã‚‹ãŸã³ã«å¬‰ã—ããªã‚Šã¾ã™ã€‚ã€',
  'ãã‚Œã„': 'ã€Œç´°éƒ¨ã¾ã§ä¸å¯§ã«ä»•ä¸Šã’ã¦ã„ãŸã ã„ã¦ã€æœ¬å½“ã«ãã‚Œã„ã§ã™ã€‚ã€',
  'ç¶ºéº—': 'ã€Œç´°éƒ¨ã¾ã§ä¸å¯§ã«ä»•ä¸Šã’ã¦ã„ãŸã ã„ã¦ã€æœ¬å½“ã«ãã‚Œã„ã§ã™ã€‚ã€'
};

function optimizeText(targetId) {
  var text = document.getElementById(targetId).value.trim();
  if (!text) { alert('ãƒã‚¤ãƒ³ãƒˆã‚„è¨€è‘‰ã‚’å…ˆã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
  var dict = targetId === 'voice' ? voiceDict : kodawariDict;
  // é•·ã„ã‚­ãƒ¼ã‹ã‚‰å…ˆã«ãƒãƒƒãƒã•ã›ã‚‹
  var keys = Object.keys(dict).sort(function(a,b){ return b.length - a.length; });
  keys.forEach(function(key) {
    text = text.replace(new RegExp(key, 'g'), dict[key]);
  });
  document.getElementById(targetId).value = text;
  alert('âœ¦ æ–‡ç« ã‚’æ•´ãˆã¾ã—ãŸï¼');
}

// =======================================
//  ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// =======================================
function esc(s) {
  if (!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function isUrl(u) {
  try { var x = new URL(u); return x.protocol==='https:'||x.protocol==='http:'; } catch(e){ return false; }
}
function toBlob(dataUrl) {
  var parts = dataUrl.split(','), mime = parts[0].match(/:(.*?);/)[1];
  var bin = atob(parts[1]), arr = new Uint8Array(bin.length);
  for (var i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i);
  return new Blob([arr],{type:mime});
}
function fd() {
  return {
    date: document.getElementById('date').value,
    pref: document.getElementById('prefecture').value,
    shop: document.getElementById('shopName').value || 'èªå®šæ–½å·¥åº—',
    k:    document.getElementById('kodawari').value,
    area: document.getElementById('area').value,
    days: document.getElementById('days').value,
    cm:   document.getElementById('colorMain').value,
    cj:   document.getElementById('colorJoint').value,
    v:    document.getElementById('voice').value,
    line: document.getElementById('lineUrl').value,
    insta:document.getElementById('instaUrl').value,
    phone:document.getElementById('phoneNum').value,
    theme:document.getElementById('selectedTheme').value
  };
}

// =======================================
//  LINE ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ”ãƒ¼
// =======================================
function copyLineText() {
  var d = fd();
  var label = d.pref ? d.pref + ' ' + d.shop : d.shop;
  var txt = 'ã€æ–½å·¥å®Œäº†å ±å‘Šã€‘\n'
    + 'â–  æ–½å·¥åº—ï¼š' + label + '\n'
    + 'â–  å®Œäº†æ—¥ï¼š' + d.date + '\n\n'
    + 'ã€æ–½å·¥ãƒ‡ãƒ¼ã‚¿ã€‘\n'
    + 'ãƒ»é¢ç©ï¼š' + (d.area||'â€”') + 'ã¡\n'
    + 'ãƒ»å·¥æœŸï¼š' + (d.days||'â€”') + 'æ—¥\n'
    + 'ãƒ»ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼ï¼š' + (d.cm||'â€”') + '\n'
    + 'ãƒ»ç›®åœ°ã‚«ãƒ©ãƒ¼ï¼š' + (d.cj||'â€”') + '\n\n'
    + 'ã€ã“ã ã‚ã‚Šãƒã‚¤ãƒ³ãƒˆã€‘\n' + (d.k||'â€”') + '\n\n'
    + 'â€» æ–½å·¥äº‹ä¾‹LPãƒ»ç”»åƒç´ æã¯æ·»ä»˜ZIPã‚’ã”ç¢ºèªãã ã•ã„ã€‚';
  navigator.clipboard.writeText(txt)
    .then(function(){ alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'); })
    .catch(function(){ alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); });
}

// =======================================
//  ãƒ†ãƒ¼ãƒå®šç¾©
// =======================================
var THEMES = {
  luxury: {
    bg:'#080808', fg:'#e8e8e8', accent:'#b8955a', accentRgb:'184,149,90',
    surface:'#111111', surface2:'#181818', border:'#252525', border2:'#2e2e2e',
    muted:'#555555', headerBg:'linear-gradient(180deg,#100c00 0%,#080808 100%)',
    badgeColor:'#b8955a', h1color:'#f0e0c0', dateColor:'#666',
    specBorder:'#1e1a10', specLabel:'#b8955a',
    baLabel:'#b8955a', sectionLine:'#b8955a',
    voiceBorder:'#2a2010', voiceColor:'#c8a870',
    ctaBg:'#b8955a', ctaColor:'#000',
    footerBg:'#060606', footerBorder:'#1a1a1a', footerText:'#444'
  },
  natural: {
    bg:'#f0ebe0', fg:'#3a2e1e', accent:'#8b6f47', accentRgb:'139,111,71',
    surface:'#faf6ee', surface2:'#f0e8d8', border:'#e0d0b8', border2:'#d0c0a0',
    muted:'#9a8a70', headerBg:'linear-gradient(180deg,#e8dfc8 0%,#f0ebe0 100%)',
    badgeColor:'#8b6f47', h1color:'#3a2e1e', dateColor:'#9a8a70',
    specBorder:'#e0d0b8', specLabel:'#8b6f47',
    baLabel:'#8b6f47', sectionLine:'#c4a882',
    voiceBorder:'#e0d0b8', voiceColor:'#6a5030',
    ctaBg:'#8b6f47', ctaColor:'#fff',
    footerBg:'#e8dfc8', footerBorder:'#d8c8b0', footerText:'#b0a080'
  },
  cool: {
    bg:'#060e1a', fg:'#dde8f4', accent:'#4a9eda', accentRgb:'74,158,218',
    surface:'#0d1825', surface2:'#121f30', border:'#1a2e44', border2:'#1e3550',
    muted:'#3a5878', headerBg:'linear-gradient(180deg,#080f1a 0%,#060e1a 100%)',
    badgeColor:'#4a9eda', h1color:'#dde8f4', dateColor:'#3a5878',
    specBorder:'#1a2e44', specLabel:'#4a9eda',
    baLabel:'#4a9eda', sectionLine:'#4a9eda',
    voiceBorder:'#1a2e44', voiceColor:'#7ab8e0',
    ctaBg:'#4a9eda', ctaColor:'#000',
    footerBg:'#050c18', footerBorder:'#111e30', footerText:'#2a4060'
  }
};

// =======================================
//  LP HTMLç”Ÿæˆ
// =======================================
function buildLP(d, t, baHtml, contactHtml, hasMain, hasSub) {

  var shopLabel = d.pref ? d.pref + '&nbsp;' + esc(d.shop) : esc(d.shop);

  var specsHtml = '';
  if (d.area) specsHtml += '<div class="spec-item"><span class="spec-label">AREA</span><span class="spec-val">' + esc(d.area) + ' <small>ã¡</small></span></div>';
  if (d.days) specsHtml += '<div class="spec-item"><span class="spec-label">DAYS</span><span class="spec-val">' + esc(d.days) + ' <small>æ—¥</small></span></div>';
  if (d.cm)   specsHtml += '<div class="spec-item"><span class="spec-label">MAIN</span><span class="spec-val">' + esc(d.cm) + '</span></div>';
  if (d.cj)   specsHtml += '<div class="spec-item"><span class="spec-label">JOINT</span><span class="spec-val">' + esc(d.cj) + '</span></div>';

  return '<!DOCTYPE html>\n<html lang="ja">\n<head>\n'
  + '<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">\n'
  + '<meta name="description" content="ROLLER STONE èªå®šæ–½å·¥åº— ' + esc(d.shop) + ' ã®æ–½å·¥äº‹ä¾‹">\n'
  + '<title>æ–½å·¥äº‹ä¾‹ | ' + esc(d.shop) + ' Ã— ROLLER STONE</title>\n'
  + '<style>\n'
  + '@import url(\'https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&display=swap\');\n'
  + '*{box-sizing:border-box;margin:0;padding:0;}\n'
  + 'html{scroll-behavior:smooth;}\n'
  + 'body{background:' + t.bg + ';color:' + t.fg + ';font-family:"Noto Sans JP","Helvetica Neue",Arial,sans-serif;line-height:1.7;-webkit-font-smoothing:antialiased;}\n'
  + 'img{max-width:100%;display:block;}\n'
  + 'a{color:inherit;text-decoration:none;}\n'

  /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
  + '.lp-header{background:' + t.headerBg + ';padding:40px 24px 32px;text-align:center;border-bottom:1px solid ' + t.border + ';}\n'
  + '.lp-badge{display:inline-flex;align-items:center;gap:8px;border:1px solid ' + t.accent + ';border-radius:4px;padding:5px 14px;margin-bottom:20px;}\n'
  + '.lp-badge-dot{width:6px;height:6px;background:' + t.accent + ';border-radius:50%;}\n'
  + '.lp-badge span{font-size:0.6rem;font-weight:700;letter-spacing:0.2em;color:' + t.badgeColor + ';}\n'
  + '.lp-shop{font-size:1.55rem;font-weight:700;color:' + t.h1color + ';letter-spacing:0.04em;line-height:1.3;margin-bottom:10px;}\n'
  + '.lp-date{font-size:0.72rem;letter-spacing:0.15em;color:' + t.dateColor + ';}\n'
  + '.lp-date span{color:' + t.accent + ';margin-right:4px;}\n'

  /* ãƒ¡ã‚¤ãƒ³ç”»åƒ */
  + '.lp-hero{position:relative;overflow:hidden;max-height:520px;}\n'
  + '.lp-hero img{width:100%;object-fit:cover;display:block;}\n'
  + '.lp-hero-overlay{position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,0.55) 0%,rgba(0,0,0,0) 55%);pointer-events:none;}\n'
  + '.lp-hero-tag{position:absolute;bottom:20px;left:20px;right:20px;}\n'
  + '.lp-hero-tag .brand{font-size:0.6rem;letter-spacing:0.2em;color:rgba(255,255,255,0.6);font-weight:700;margin-bottom:4px;}\n'
  + '.lp-hero-tag .copy{font-size:1.15rem;font-weight:700;color:#fff;letter-spacing:0.06em;line-height:1.4;text-shadow:0 2px 12px rgba(0,0,0,0.6);}\n'

  /* ã‚³ãƒ³ãƒ†ãƒŠ */
  + '.lp-body{max-width:640px;margin:0 auto;padding:0 0 80px;}\n'

  /* ã‚¹ãƒšãƒƒã‚¯ã‚«ãƒ¼ãƒ‰ */
  + '.spec-strip{background:' + t.surface + ';border-bottom:1px solid ' + t.border + ';padding:0 20px;}\n'
  + '.spec-inner{display:flex;overflow-x:auto;gap:0;-ms-overflow-style:none;scrollbar-width:none;}\n'
  + '.spec-inner::-webkit-scrollbar{display:none;}\n'
  + '.spec-item{flex:1;min-width:70px;padding:16px 10px;text-align:center;border-right:1px solid ' + t.specBorder + ';}\n'
  + '.spec-item:last-child{border-right:none;}\n'
  + '.spec-label{display:block;font-size:0.55rem;font-weight:700;letter-spacing:0.15em;color:' + t.specLabel + ';margin-bottom:4px;}\n'
  + '.spec-val{font-size:0.78rem;font-weight:700;letter-spacing:0.02em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}\n'
  + '.spec-val small{font-size:0.65rem;font-weight:400;}\n'

  /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³å…±é€š */
  + '.lp-sec{padding:36px 20px;border-bottom:1px solid ' + t.border + ';}\n'
  + '.lp-sec:last-of-type{border-bottom:none;}\n'
  + '.sec-head{display:flex;align-items:center;gap:12px;margin-bottom:20px;}\n'
  + '.sec-head .line{flex:1;height:1px;background:' + t.border + ';}\n'
  + '.sec-head .en{font-size:0.6rem;font-weight:800;letter-spacing:0.2em;color:' + t.sectionLine + ';}\n'
  + '.sec-head .ja{font-size:0.8rem;color:' + t.muted + ';}\n'

  /* ã“ã ã‚ã‚Šãƒã‚¤ãƒ³ãƒˆ */
  + '.kodawari-text{font-size:0.95rem;line-height:1.9;white-space:pre-wrap;}\n'

  /* BA */
  + '.ba-wrap{display:grid;grid-template-columns:1fr 1fr;gap:2px;border-radius:10px;overflow:hidden;margin-bottom:20px;}\n'
  + '.ba-side{position:relative;}\n'
  + '.ba-side img{width:100%;aspect-ratio:1/1;object-fit:cover;display:block;}\n'
  + '.ba-tag{position:absolute;top:10px;left:10px;background:rgba(0,0,0,0.65);color:#fff;font-size:0.58rem;font-weight:700;letter-spacing:0.15em;padding:3px 8px;border-radius:3px;}\n'
  + '.ba-tag.after{background:' + t.accent + ';color:#000;}\n'
  + '.ba-num{font-size:0.62rem;font-weight:700;letter-spacing:0.12em;color:' + t.baLabel + ';margin-bottom:10px;margin-top:4px;}\n'

  /* ãŠå®¢æ§˜ã®å£° */
  + '.voice-card{border:1px solid ' + t.voiceBorder + ';border-radius:10px;padding:20px 20px 20px 24px;position:relative;}\n'
  + '.voice-card::before{content:\'"\';position:absolute;top:-8px;left:16px;font-size:2.5rem;color:' + t.accent + ';line-height:1;font-family:Georgia,serif;}\n'
  + '.voice-text{font-size:0.9rem;line-height:1.85;color:' + t.voiceColor + ';font-style:italic;white-space:pre-wrap;}\n'

  /* æ–½å·¥é¢¨æ™¯ */
  + '.sub-img{width:100%;border-radius:10px;overflow:hidden;}\n'
  + '.sub-img img{width:100%;display:block;}\n'

  /* ãŠå•ã„åˆã‚ã› */
  + '.cta-wrap{padding:36px 20px;background:' + t.surface + ';}\n'
  + '.cta-title{text-align:center;font-size:0.65rem;font-weight:700;letter-spacing:0.2em;color:' + t.accent + ';margin-bottom:20px;}\n'
  + '.cta-btn{display:flex;align-items:center;justify-content:center;gap:10px;width:100%;padding:16px;border-radius:50px;font-weight:700;font-size:0.95rem;margin-bottom:12px;box-sizing:border-box;transition:opacity 0.2s;}\n'
  + '.cta-btn:hover{opacity:0.85;}\n'
  + '.btn-green{background:#06c755;color:#fff;}\n'
  + '.btn-insta{background:linear-gradient(135deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888);color:#fff;}\n'
  + '.btn-accent{background:' + t.ctaBg + ';color:' + t.ctaColor + ';}\n'

  /* ãƒ•ãƒƒã‚¿ãƒ¼ */
  + '.lp-footer{background:' + t.footerBg + ';border-top:1px solid ' + t.footerBorder + ';padding:28px 20px;text-align:center;}\n'
  + '.lp-footer .rs-mark{font-size:0.58rem;font-weight:700;letter-spacing:0.2em;color:' + t.footerText + ';}\n'
  + '.lp-footer .rs-copy{font-size:0.62rem;color:' + t.footerText + ';margin-top:6px;}\n'
  + '.lp-footer .rs-date{font-size:0.6rem;color:' + t.footerText + ';margin-top:4px;letter-spacing:0.1em;}\n'
  + '</style>\n</head>\n<body>\n'

  /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
  + '<header class="lp-header">\n'
  + '  <div class="lp-badge"><div class="lp-badge-dot"></div><span>ROLLER STONE èªå®šæ–½å·¥åº—</span></div>\n'
  + '  <h1 class="lp-shop">' + shopLabel + '</h1>\n'
  + ''
  + '</header>\n'

  /* ãƒ¡ã‚¤ãƒ³ç”»åƒ */
  + (hasMain ? '<div class="lp-hero"><img src="main.jpg" alt="æ–½å·¥å®Œäº†å†™çœŸ"><div class="lp-hero-overlay"></div><div class="lp-hero-tag"><div class="brand">ROLLER STONE Ã— ' + esc(d.shop) + '</div><div class="copy">å£Šã•ãšã€Re:ãƒ‡ã‚¶ã‚¤ãƒ³ã€‚</div></div></div>\n' : '')

  /* ã‚¹ãƒšãƒƒã‚¯ */
  + (specsHtml ? '<div class="spec-strip"><div class="spec-inner">' + specsHtml + '</div></div>\n' : '')

  + '<div class="lp-body">\n'

  /* ã“ã ã‚ã‚Šãƒã‚¤ãƒ³ãƒˆ */
  + (d.k ? '<div class="lp-sec">'
    + '<div class="sec-head"><div class="en">CRAFTMANSHIP</div><div class="line"></div><div class="ja">æ–½å·¥ã®ã“ã ã‚ã‚Š</div></div>'
    + '<p class="kodawari-text">' + esc(d.k) + '</p>'
    + '</div>\n' : '')

  /* BA */
  + (baHtml ? '<div class="lp-sec">'
    + '<div class="sec-head"><div class="en">BEFORE / AFTER</div><div class="line"></div></div>'
    + baHtml
    + '</div>\n' : '')

  /* ãŠå®¢æ§˜ã®å£° */
  + (d.v ? '<div class="lp-sec">'
    + '<div class="sec-head"><div class="en">CUSTOMER VOICE</div><div class="line"></div><div class="ja">ãŠå®¢æ§˜ã®å£°</div></div>'
    + '<div class="voice-card"><p class="voice-text">' + esc(d.v) + '</p></div>'
    + '</div>\n' : '')

  /* æ–½å·¥é¢¨æ™¯ */
  + (hasSub ? '<div class="lp-sec">'
    + '<div class="sec-head"><div class="en">CONSTRUCTION</div><div class="line"></div><div class="ja">æ–½å·¥é¢¨æ™¯</div></div>'
    + '<div class="sub-img"><img src="sub.jpg" alt="æ–½å·¥é¢¨æ™¯"></div>'
    + '</div>\n' : '')

  /* ãŠå•ã„åˆã‚ã› */
  + (contactHtml ? '<div class="cta-wrap"><p class="cta-title">â€” CONTACT â€”</p>' + contactHtml + '</div>\n' : '')

  + '</div>\n'

  /* ãƒ•ãƒƒã‚¿ãƒ¼ */
  + '<footer class="lp-footer">'
  + '<p class="rs-mark">RSW DX PORTAL â€” ROLLER STONE / ROLLER WALL</p>'
  + '<p class="rs-copy">Â© ROLLER STONE èªå®šæ–½å·¥åº— ' + esc(d.shop) + '</p>'
  + '<p class="rs-date">æ–½å·¥å®Œäº†ï¼š' + esc(d.date) + '</p>'
  + '</footer>\n'
  + '</body>\n</html>';
}


// =======================================
//  LP ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
// =======================================
function openPreview() {
  var d = fd();
  var t = THEMES[d.theme] || THEMES.luxury;

  // BAãƒšã‚¢åé›†
  var pairEls = document.querySelectorAll('.ba-pair');
  var pids = Array.from(pairEls).map(function(el){ return el.id.replace('baPair_',''); });

  var baHtml = '';
  pids.forEach(function(pid, idx) {
    var hB = !!baPairImages['before_' + pid];
    var hA = !!baPairImages['after_' + pid];
    if (!hB && !hA) return;
    baHtml += (pids.length > 1 ? '<p class="ba-num">PAIR ' + String(idx+1).padStart(2,'0') + '</p>' : '')
      + '<div class="ba-wrap">'
      + '<div class="ba-side">' + (hB ? '<img src="' + baPairImages['before_' + pid] + '" alt="Before"><div class="ba-tag">BEFORE</div>' : '') + '</div>'
      + '<div class="ba-side">' + (hA ? '<img src="' + baPairImages['after_' + pid] + '" alt="After"><div class="ba-tag after">AFTER</div>' : '') + '</div>'
      + '</div>';
  });

  var contactHtml = '';
  if (d.line && isUrl(d.line))   contactHtml += '<a href="' + esc(d.line) + '" class="cta-btn btn-green">ğŸ’¬ å…¬å¼LINEã§ãŠå•ã„åˆã‚ã›</a>';
  if (d.insta && isUrl(d.insta)) contactHtml += '<a href="' + esc(d.insta) + '" class="cta-btn btn-insta">ğŸ“¸ Instagramã§äº‹ä¾‹ã‚’ã‚‚ã£ã¨è¦‹ã‚‹</a>';
  if (d.phone)                    contactHtml += '<a href="tel:' + esc(d.phone) + '" class="cta-btn btn-accent">ğŸ“ ' + esc(d.phone) + '</a>';

  var hasMain = !!singleImages['imgMain'];
  var hasSub  = !!singleImages['imgSub'];

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨LP â€” ç”»åƒã‚’Base64ã§ç›´æ¥åŸ‹ã‚è¾¼ã‚€
  var html = buildLP(d, t, baHtml, contactHtml, hasMain, hasSub);

  // ç”»åƒãƒ‘ã‚¹ã‚’Base64ã«å·®ã—æ›¿ãˆ
  if (hasMain) html = html.replace('src="main.jpg"', 'src="' + singleImages['imgMain'] + '"');
  if (hasSub)  html = html.replace('src="sub.jpg"',  'src="' + singleImages['imgSub'] + '"');
  pids.forEach(function(pid) {
    if (baPairImages['before_' + pid]) html = html.replace('src="before_' + pid + '.jpg"', 'src="' + baPairImages['before_' + pid] + '"');
    if (baPairImages['after_' + pid])  html = html.replace('src="after_' + pid + '.jpg"',  'src="' + baPairImages['after_' + pid] + '"');
  });

  // iframeã«æ›¸ãè¾¼ã‚€
  var modal = document.getElementById('previewModal');
  var iframe = document.getElementById('previewIframe');
  modal.style.display = 'flex';
  document.body.style.overflow = 'hidden';

  // blob URLã§èª­ã¿è¾¼ã‚€ï¼ˆsrcãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›¸ãè¾¼ã¿ã‚ˆã‚Šå®‰å®šï¼‰
  var blob = new Blob([html], {type: 'text/html'});
  var url = URL.createObjectURL(blob);
  iframe.onload = function() { URL.revokeObjectURL(url); };
  iframe.src = url;

  // SPè¡¨ç¤ºã«ãƒªã‚»ãƒƒãƒˆ
  setPreviewDevice('sp');
}

function closePreview() {
  var modal = document.getElementById('previewModal');
  modal.style.display = 'none';
  document.body.style.overflow = '';
  var iframe = document.getElementById('previewIframe');
  iframe.src = 'about:blank';
}

function setPreviewDevice(mode) {
  var frame = document.getElementById('previewFrame');
  var btnSp = document.getElementById('btn-sp');
  var btnPc = document.getElementById('btn-pc');
  var goldStyle  = 'background:#b8955a;color:#000;border:none;border-radius:6px;padding:6px 12px;font-size:0.72rem;font-weight:700;cursor:pointer;';
  var plainStyle = 'background:#222;color:#888;border:1px solid #333;border-radius:6px;padding:6px 12px;font-size:0.72rem;font-weight:700;cursor:pointer;';
  if (mode === 'sp') {
    frame.style.width = '390px';
    btnSp.style.cssText = goldStyle;
    btnPc.style.cssText = plainStyle;
  } else {
    frame.style.width = '100%';
    frame.style.maxWidth = '900px';
    btnPc.style.cssText = goldStyle;
    btnSp.style.cssText = plainStyle;
  }
}

// ESCã‚­ãƒ¼ã§é–‰ã˜ã‚‹
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closePreview();
});

// =======================================
//  ZIPç”Ÿæˆ
// =======================================
async function generateZip() {
  var btn = document.getElementById('generateZipBtn');
  var d = fd();
  if (!d.shop || d.shop === 'èªå®šæ–½å·¥åº—') {
    alert('èªå®šæ–½å·¥åº—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
    document.getElementById('shopName').focus(); return;
  }
  btn.disabled = true; btn.textContent = 'ç”Ÿæˆä¸­...';

  try {
    var t = THEMES[d.theme] || THEMES.luxury;

    // BAãƒšã‚¢åé›†
    var pairEls = document.querySelectorAll('.ba-pair');
    var pids = Array.from(pairEls).map(function(el){ return el.id.replace('baPair_',''); });

    // BA HTML
    var baHtml = '';
    pids.forEach(function(pid, idx) {
      var hB = !!baPairImages['before_' + pid];
      var hA = !!baPairImages['after_' + pid];
      if (!hB && !hA) return;
      baHtml += (pids.length > 1 ? '<p class="ba-num">PAIR ' + String(idx+1).padStart(2,'0') + '</p>' : '')
        + '<div class="ba-wrap">'
        + '<div class="ba-side">' + (hB ? '<img src="before_' + pid + '.jpg" alt="Before"><div class="ba-tag">BEFORE</div>' : '') + '</div>'
        + '<div class="ba-side">' + (hA ? '<img src="after_' + pid + '.jpg" alt="After"><div class="ba-tag after">AFTER</div>' : '') + '</div>'
        + '</div>';
    });

    // ãŠå•ã„åˆã‚ã›
    var contactHtml = '';
    if (d.line && isUrl(d.line))   contactHtml += '<a href="' + esc(d.line) + '" class="cta-btn btn-green">ğŸ’¬ å…¬å¼LINEã§ãŠå•ã„åˆã‚ã›</a>';
    if (d.insta && isUrl(d.insta)) contactHtml += '<a href="' + esc(d.insta) + '" class="cta-btn btn-insta">ğŸ“¸ Instagramã§äº‹ä¾‹ã‚’ã‚‚ã£ã¨è¦‹ã‚‹</a>';
    if (d.phone)                    contactHtml += '<a href="tel:' + esc(d.phone) + '" class="cta-btn btn-accent">ğŸ“ ' + esc(d.phone) + '</a>';

    var hasMain = !!singleImages['imgMain'];
    var hasSub  = !!singleImages['imgSub'];

    var html = buildLP(d, t, baHtml, contactHtml, hasMain, hasSub);

    // ZIP
    var zip = new JSZip();
    zip.file('index.html', html);
    if (hasMain) zip.file('main.jpg', toBlob(singleImages['imgMain']));
    if (hasSub)  zip.file('sub.jpg',  toBlob(singleImages['imgSub']));
    pids.forEach(function(pid) {
      if (baPairImages['before_' + pid]) zip.file('before_' + pid + '.jpg', toBlob(baPairImages['before_' + pid]));
      if (baPairImages['after_' + pid])  zip.file('after_' + pid + '.jpg',  toBlob(baPairImages['after_' + pid]));
    });

    var blob = await zip.generateAsync({ type:'blob', compression:'DEFLATE', compressionOptions:{level:6} });
    saveAs(blob, 'RS_' + d.date + '_' + d.shop + '.zip');

    btn.textContent = 'âœ“ ç”Ÿæˆå®Œäº†ï¼ã‚‚ã†ä¸€åº¦ç”Ÿæˆã™ã‚‹';
    btn.disabled = false;
    alert('ğŸ“¦ ZIPã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼\n\nâ‘  LINEå ±å‘Šãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼\nâ‘¡ ZIPã‚’LINEã«æ·»ä»˜ã—ã¦æœ¬éƒ¨ã¸é€ä¿¡\n\nâ€» index.html ã¯æ–½å·¥åº—ã®SNSãƒ»åºƒå‘Šã«ã‚‚ãã®ã¾ã¾æ´»ç”¨ã§ãã¾ã™');

  } catch(err) {
    console.error(err);
    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š' + err.message);
    btn.textContent = 'ğŸ“¦ æ–½å·¥äº‹ä¾‹ LP ã‚’ç”Ÿæˆï¼ˆZIPï¼‰';
    btn.disabled = false;
  }
}
</script>
</body>
</html>
